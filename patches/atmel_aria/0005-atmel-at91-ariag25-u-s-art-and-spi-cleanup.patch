From 8b188439ccaa0caa302f0886d4b6d1fdd3beab3c Mon Sep 17 00:00:00 2001
From: Robert Nelson <robertcnelson@gmail.com>
Date: Wed, 2 Jan 2013 08:58:23 -0600
Subject: [PATCH 5/5] atmel: at91: ariag25: u(s)art and spi cleanup

Signed-off-by: Douglas Gilbert <dgilbert@interlog.com>
Signed-off-by: Robert Nelson <robertcnelson@gmail.com>
---
 arch/arm/boot/dts/ariag25.dts     |   71 ++++++++++++++++++++++++++++++++-----
 arch/arm/boot/dts/at91sam9x5.dtsi |   38 ++++++++++----------
 arch/arm/mach-at91/at91sam9x5.c   |    6 ++--
 3 files changed, 86 insertions(+), 29 deletions(-)

diff --git a/arch/arm/boot/dts/ariag25.dts b/arch/arm/boot/dts/ariag25.dts
index aa75bf9..89dd6dd 100644
--- a/arch/arm/boot/dts/ariag25.dts
+++ b/arch/arm/boot/dts/ariag25.dts
@@ -1,29 +1,45 @@
 /*
  * ariag25.dts - Device Tree file for Acme Systems Aria G25 (AT91SAM9G25 based)
  * Compile with dtc in <kernel_src/arch/arm/boot/dts> folder:
- *  'dtc -O dtb -o ariag25.dtb ariag25.dts'                      [dpg 20121113]
+ *  'dtc -O dtb -o ariag25.dtb ariag25.dts'			 [dpg 20121230]
  *
  * N.B. The 'interrupts' entry explained in:
  *     <kernel_src>/Documentation/devicetree/bindings/arm/atmel-aic.txt
  */
 /dts-v1/;
-/include/ "at91sam9x5.dtsi"
-/*   /include/ "at91sam9x5cm.dtsi"	*/
+/include/ "at91sam9g25.dtsi"
 
 / {
 	model = "Acme Systems Aria G25";
 	compatible = "atmel,at91sam9g25ek", "atmel,at91sam9x5ek", "atmel,at91sam9x5", "atmel,at91sam9";
 
+	/* at91sam9x5.dtsi defines serial0=&dbgu; serial1=&usart0; serial2=&usart1;
+	 * serial3 = &usart2; */
 	aliases {
 		serial4 = &usart3;
-		serial5 = &usart4;
-		serial6 = &usart5;
+		serial5 = &uart0;
+		serial6 = &uart1;
 	};
 
 	chosen {
 		bootargs = "console=ttyS0,115200 root=/dev/mtdblock1 rw rootfstype=ubifs ubi.mtd=1 root=ubi0:rootfs";
 	};
 
+	memory {
+		reg = <0x20000000 0x8000000>;
+	};
+
+	clocks {
+		#address-cells = <1>;
+		#size-cells = <1>;
+		ranges;
+
+		main_clock: clock@0 {
+			compatible = "atmel,osc", "fixed-clock";
+			clock-frequency = <12000000>;
+		};
+	};
+
 	ahb {
 		apb {
 			dbgu: serial@fffff200 {
@@ -31,14 +47,23 @@
 			};
 
 			usart0: serial@f801c000 {
+				pinctrl-0 = <&pinctrl_usart0
+					     &pinctrl_usart0_rts
+					     &pinctrl_usart0_cts>;
 				status = "okay";
 			};
 
 			usart1: serial@f8020000 {
+				pinctrl-0 = <&pinctrl_usart1
+					     &pinctrl_usart1_rts
+					     &pinctrl_usart1_cts>;
 				status = "okay";
 			};
 
 			usart2: serial@f8024000 {
+				/* cannot activate RTS2+CTS2, clash with
+				 * ethernet on PB0 and PB1 */
+				pinctrl-0 = <&pinctrl_usart2>;
 				status = "okay";
 			};
 
@@ -48,20 +73,28 @@
 				interrupts = <8 4 5>;
 				atmel,use-dma-rx;
 				atmel,use-dma-tx;
+				pinctrl-names = "default";
+				pinctrl-0 = <&pinctrl_usart3
+					     &pinctrl_usart3_rts
+					     &pinctrl_usart3_cts>;
 				status = "okay";
 			};
 
-			usart4: serial@f8040000 {
+			uart0: serial@f8040000 {
 				compatible = "atmel,at91sam9260-usart";
 				reg = <0xf8040000 0x200>;
 				interrupts = <15 4 5>;
+				pinctrl-names = "default";
+				pinctrl-0 = <&pinctrl_uart0>;
 				status = "okay";
 			};
 
-			usart5: serial@f8044000 {
+			uart1: serial@f8044000 {
 				compatible = "atmel,at91sam9260-usart";
 				reg = <0xf8044000 0x200>;
 				interrupts = <16 4 5>;
+				pinctrl-names = "default";
+				pinctrl-0 = <&pinctrl_uart1>;
 				status = "okay";
 			};
 
@@ -83,6 +116,11 @@
 			/* TWD2+TCLK2 hidden behind ethernet, so no i2c2 */
 
 			mmc0: mmc@f0008000 {
+				/* N.B. Aria has no SD card detect (CD), assumed present */
+
+				pinctrl-0 = <
+					&pinctrl_mmc0_slot0_clk_cmd_dat0
+					&pinctrl_mmc0_slot0_dat1_3>;
 				status = "okay";
 				slot@0 {
 					reg = <0>;
@@ -90,6 +128,23 @@
 				};
 			};
 
+			spi0: spi@f0000000 {
+				compatible = "atmel,at91rm9200-spi";
+				reg = <0xf0000000 0x4000>;
+				interrupts = <13 4 5>;
+				#address-cells = <1>;
+				#size-cells = <0>;
+				cs-gpios = <&pioA 14 0>;
+				status = "okay";
+
+				/* mmc-slot@0 {
+				 *	compatible = "mmc-spi-slot";
+				 *	reg = <0>; */
+				/*	gpios = <&pioC 4 0>;    CD */
+				/*	spi-max-frequency = <25000000>;
+				 * }; */
+			};
+
 		};
 
 		usb0: ohci@00600000 {
@@ -112,7 +167,7 @@
 		/* little green LED in middle of Aria G25 module */
 		aria_led {
 			label = "aria_led";
-			gpios = <&pioB 8 0>;
+			gpios = <&pioB 8 0>;	/* PB8 */
 			linux,default-trigger = "heartbeat";
 		};
 
diff --git a/arch/arm/boot/dts/at91sam9x5.dtsi b/arch/arm/boot/dts/at91sam9x5.dtsi
index 40ac3a4..29afc61 100644
--- a/arch/arm/boot/dts/at91sam9x5.dtsi
+++ b/arch/arm/boot/dts/at91sam9x5.dtsi
@@ -129,7 +129,7 @@
 				dbgu {
 					pinctrl_dbgu: dbgu-0 {
 						atmel,pins =
-							<0 9 0x1 0x0	/* PA9 periph A */
+							<0 9 0x1 0x0	/* PA9 periph A (rxd) */
 							 0 10 0x1 0x1>;	/* PA10 periph A with pullup */
 					};
 				};
@@ -138,7 +138,7 @@
 					pinctrl_usart0: usart0-0 {
 						atmel,pins =
 							<0 0 0x1 0x1	/* PA0 periph A with pullup */
-							 0 1 0x1 0x0>;	/* PA1 periph A */
+							 0 1 0x1 0x0>;	/* PA1 periph A (rxd) */
 					};
 
 					pinctrl_usart0_rts: usart0_rts-0 {
@@ -156,17 +156,17 @@
 					pinctrl_usart1: usart1-0 {
 						atmel,pins =
 							<0 5 0x1 0x1	/* PA5 periph A with pullup */
-							 0 6 0x1 0x0>;	/* PA6 periph A */
+							 0 6 0x1 0x0>;	/* PA6 periph A (rxd) */
 					};
 
 					pinctrl_usart1_rts: usart1_rts-0 {
 						atmel,pins =
-							<3 27 0x3 0x0>;	/* PC27 periph C */
+							<2 27 0x3 0x0>;	/* PC27 periph C */
 					};
 
 					pinctrl_usart1_cts: usart1_cts-0 {
 						atmel,pins =
-							<3 28 0x3 0x0>;	/* PC28 periph C */
+							<2 28 0x3 0x0>;	/* PC28 periph C */
 					};
 				};
 
@@ -174,51 +174,51 @@
 					pinctrl_usart2: usart2-0 {
 						atmel,pins =
 							<0 7 0x1 0x1	/* PA7 periph A with pullup */
-							 0 8 0x1 0x0>;	/* PA8 periph A */
+							 0 8 0x1 0x0>;	/* PA8 periph A (rxd) */
 					};
 
-					pinctrl_uart2_rts: uart2_rts-0 {
+					pinctrl_usart2_rts: usart2_rts-0 {
 						atmel,pins =
-							<0 0 0x2 0x0>;	/* PB0 periph B */
+							<1 0 0x2 0x0>;	/* PB0 periph B */
 					};
 
-					pinctrl_uart2_cts: uart2_cts-0 {
+					pinctrl_usart2_cts: usart2_cts-0 {
 						atmel,pins =
-							<0 1 0x2 0x0>;	/* PB1 periph B */
+							<1 1 0x2 0x0>;	/* PB1 periph B */
 					};
 				};
 
 				usart3 {
-					pinctrl_uart3: usart3-0 {
+					pinctrl_usart3: usart3-0 {
 						atmel,pins =
-							<3 23 0x2 0x1	/* PC22 periph B with pullup */
-							 3 23 0x2 0x0>;	/* PC23 periph B */
+							<2 22 0x2 0x1	/* PC22 periph B with pullup */
+							 2 23 0x2 0x0>;	/* PC23 periph B (rxd) */
 					};
 
 					pinctrl_usart3_rts: usart3_rts-0 {
 						atmel,pins =
-							<3 24 0x2 0x0>;	/* PC24 periph B */
+							<2 24 0x2 0x0>;	/* PC24 periph B */
 					};
 
 					pinctrl_usart3_cts: usart3_cts-0 {
 						atmel,pins =
-							<3 25 0x2 0x0>;	/* PC25 periph B */
+							<2 25 0x2 0x0>;	/* PC25 periph B */
 					};
 				};
 
 				uart0 {
 					pinctrl_uart0: uart0-0 {
 						atmel,pins =
-							<3 8 0x3 0x0	/* PC8 periph C */
-							 3 9 0x3 0x1>;	/* PC9 periph C with pullup */
+							<2 8 0x3 0x1	/* PC9 periph C with pullup */
+							 2 9 0x3 0x0>;	/* PC8 periph C (rxd) */
 					};
 				};
 
 				uart1 {
 					pinctrl_uart1: uart1-0 {
 						atmel,pins =
-							<3 16 0x3 0x0	/* PC16 periph C */
-							 3 17 0x3 0x1>;	/* PC17 periph C with pullup */
+							<2 16 0x3 0x1	/* PC16 periph C with pullup */
+							 2 17 0x3 0x0>;	/* PC17 periph C (rxd) */
 					};
 				};
 
diff --git a/arch/arm/mach-at91/at91sam9x5.c b/arch/arm/mach-at91/at91sam9x5.c
index 9c38547..0bf88c9 100644
--- a/arch/arm/mach-at91/at91sam9x5.c
+++ b/arch/arm/mach-at91/at91sam9x5.c
@@ -227,8 +227,8 @@ static struct clk_lookup periph_clocks_lookups[] = {
 	CLKDEV_CON_DEV_ID("usart", "f8020000.serial", &usart1_clk),
 	CLKDEV_CON_DEV_ID("usart", "f8024000.serial", &usart2_clk),
 	CLKDEV_CON_DEV_ID("usart", "f8028000.serial", &usart3_clk),
-	CLKDEV_CON_DEV_ID("uart", "f8040000.serial", &uart0_clk),
-	CLKDEV_CON_DEV_ID("uart", "f8044000.serial", &uart1_clk),
+	CLKDEV_CON_DEV_ID("usart", "f8040000.serial", &uart0_clk),
+	CLKDEV_CON_DEV_ID("usart", "f8044000.serial", &uart1_clk),
 	CLKDEV_CON_DEV_ID("t0_clk", "f8008000.timer", &tcb0_clk),
 	CLKDEV_CON_DEV_ID("t0_clk", "f800c000.timer", &tcb0_clk),
 	CLKDEV_CON_DEV_ID("mci_clk", "f0008000.mmc", &mmc0_clk),
@@ -236,6 +236,8 @@ static struct clk_lookup periph_clocks_lookups[] = {
 	CLKDEV_CON_DEV_ID("dma_clk", "ffffec00.dma-controller", &dma0_clk),
 	CLKDEV_CON_DEV_ID("dma_clk", "ffffee00.dma-controller", &dma1_clk),
 	CLKDEV_CON_DEV_ID("pclk", "f0010000.ssc", &ssc_clk),
+	CLKDEV_CON_DEV_ID("spi_clk", "f0000000.spi", &spi0_clk),
+	CLKDEV_CON_DEV_ID("spi_clk", "f0004000.spi", &spi1_clk),
 	CLKDEV_CON_DEV_ID(NULL, "f8010000.i2c", &twi0_clk),
 	CLKDEV_CON_DEV_ID(NULL, "f8014000.i2c", &twi1_clk),
 	CLKDEV_CON_DEV_ID(NULL, "f8018000.i2c", &twi2_clk),
-- 
1.7.10.4

