From b04196c08fd2c71d797d0faa1abda318048d80a3 Mon Sep 17 00:00:00 2001
From: Robert Nelson <robertcnelson@gmail.com>
Date: Thu, 7 Mar 2013 11:27:57 -0600
Subject: [PATCH 7/7] atmel: at91: ariag25, spi fixes

Signed-off-by: Douglas Gilbert <dgilbert@interlog.com>
Signed-off-by: Robert Nelson <robertcnelson@gmail.com>
---
 arch/arm/boot/dts/ariag25.dts     |   91 +++++++++++--------------------------
 arch/arm/boot/dts/at91sam9x5.dtsi |    7 +++
 drivers/mmc/host/of_mmc_spi.c     |   28 +++++++++---
 3 files changed, 55 insertions(+), 71 deletions(-)

diff --git a/arch/arm/boot/dts/ariag25.dts b/arch/arm/boot/dts/ariag25.dts
index a74cd4b..4b4ff00 100644
--- a/arch/arm/boot/dts/ariag25.dts
+++ b/arch/arm/boot/dts/ariag25.dts
@@ -1,7 +1,7 @@
 /*
  * ariag25.dts - Device Tree file for Acme Systems Aria G25 (AT91SAM9G25 based)
  * Compile with dtc in <kernel_src/arch/arm/boot/dts> folder:
- *  'dtc -O dtb -o ariag25.dtb ariag25.dts'			 [dpg 20130114]
+ *  'dtc -O dtb -o ariag25.dtb ariag25.dts'			 [dpg 20130306]
  *
  * N.B. The 'interrupts' entry explained in:
  *     <kernel_src>/Documentation/devicetree/bindings/arm/atmel-aic.txt
@@ -44,54 +44,6 @@
 		apb {
 
 			pinctrl@fffff400 {
-                                spi0 {
-                                        pinctrl_spi0_miso_mosi_spck: spi0_miso_mosi_spck-0 {
-                                                atmel,pins =
-                                                        <0 11 0x1 0x0     /* PA11 periph A */
-                                                         0 12 0x1 0x0     /* PA12 periph A */
-                                                         0 13 0x1 0x0>;   /* PA13 periph A */
-                                        };
-                                        pinctrl_spi0_cs0: spi0_cs0-0 {
-                                                atmel,pins =
-                                                        <0 14 0x1 0x0>;   /* PA14 periph A */
-                                        };
-                                        pinctrl_spi0_cs1: spi0_cs1-0 {
-                                                atmel,pins =
-                                                        <0 7 0x2 0x0>;    /* PA7 periph B */
-                                        };
-                                        pinctrl_spi0_cs2: spi0_cs2-0 {
-                                                atmel,pins =
-                                                        <0 1 0x2 0x0>;    /* PA1 periph B */
-                                        };
-                                        pinctrl_spi0_cs3: spi0_cs3-0 {
-                                                atmel,pins =
-                                                        <1 3 0x2 0x0>;    /* PB3 periph B */
-                                        };
-				};
-                                spi1 {
-                                        pinctrl_spi1_miso_mosi_spck: spi1_miso_mosi_spck-0 {
-                                                atmel,pins =
-                                                        <0 21 0x2 0x0     /* PA21 periph B */
-                                                         0 22 0x2 0x0     /* PA12 periph B */
-                                                         0 23 0x2 0x0>;   /* PA13 periph B */
-                                        };
-                                        pinctrl_spi1_cs0: spi1_cs0-0 {
-                                                atmel,pins =
-                                                        <0 8 0x2 0x0>;    /* PA8 periph B */
-                                        };
-                                        pinctrl_spi1_cs1: spi1_cs1-0 {
-                                                atmel,pins =
-                                                        <0 0 0x2 0x0>;    /* PA0 periph B */
-                                        };
-                                        pinctrl_spi1_cs2: spi1_cs2-0 {
-                                                atmel,pins =
-                                                        <0 31 0x2 0x0>;   /* PA31 periph B */
-                                        };
-                                        pinctrl_spi1_cs3: spi1_cs3-0 {
-                                                atmel,pins =
-                                                        <1 30 0x2 0x0>;   /* PB30 periph B */
-                                        };
-				};
 				w1_0 {
                                         pinctrl_w1_0: w1_0-0 {
                                                 atmel,pins =
@@ -190,21 +142,29 @@
 
 			spi0: spi@f0000000 {
 				status = "okay";
-				/* cs-gpios = <&pioA 14 0>; */
-				cs-gpios = <&pioA 29 0>;	/* safe unused, testing */
-				/* cs-gpios = <&pinctrl_spi0_cs0 0 0>; */
-				pinctrl-names = "default";
-				pinctrl-0 = <
-					&pinctrl_spi0_miso_mosi_spck
-					&pinctrl_spi0_cs0>;
+				cs-gpios = <&pioA 14 0>, <0>, <0>, <0>;
+				// anything@0 {
+					// compatible = "spidev";
+					// // spi-max-frequency = <50000000>;
+					// spi-max-frequency = <1000000>;
+					// reg = <0>;
+				// };
+				// m25p80@0 {
+					// compatible = "spidev";
+					// spi-max-frequency = <50000000>;
+					// reg = <0>;
+				// };
 
 				mmc-slot@0 {
 					compatible = "mmc-spi-slot";
-					/* reg = <0>; */
+					reg = <0>;
 					voltage-ranges = <3300 3300>;
-					/*	gpios = <&pioC 4 0>;    CD */
-					broken-cd;
-					spi-max-frequency = <5000000>;
+					// Use one of next 3 lines, comment out other 2
+					gpios = <&pioA 26 0>;    /* CD to PA26 */
+					// broken-cd;
+					// non-removable;
+					cd-inverted;
+					spi-max-frequency = <4000000>;
 				 };
 			};
 
@@ -214,6 +174,12 @@
                                 atmel,adc-num-channels = <4>;
 			};
 
+			watchdog@fffffe40 {
+				compatible = "atmel,at91sam9260-wdt";
+				reg = <0xfffffe40 0x10>;
+				status = "okay";
+			};
+
 		};
 
 		usb0: ohci@00600000 {
@@ -252,10 +218,7 @@
 	};
 
 	rtc {
-		compatible = "atmel,at91sam9x5-rtc";
-
-		reg = <0xfffffeb0 0x40>;
-		interrupts = <1 4 7>;
+		status = "okay";
 	};
 
 };
diff --git a/arch/arm/boot/dts/at91sam9x5.dtsi b/arch/arm/boot/dts/at91sam9x5.dtsi
index 04fbf9d..98c9013 100644
--- a/arch/arm/boot/dts/at91sam9x5.dtsi
+++ b/arch/arm/boot/dts/at91sam9x5.dtsi
@@ -621,4 +621,11 @@
 		#size-cells = <0>;
 		status = "disabled";
 	};
+
+	rtc {
+		compatible = "atmel,at91sam9x5-rtc";
+		reg = <0xfffffeb0 0x40>;
+		interrupts = <1 4 7>;
+		status = "disabled";
+	};
 };
diff --git a/drivers/mmc/host/of_mmc_spi.c b/drivers/mmc/host/of_mmc_spi.c
index d720b5e..c06abb2 100644
--- a/drivers/mmc/host/of_mmc_spi.c
+++ b/drivers/mmc/host/of_mmc_spi.c
@@ -64,6 +64,11 @@ static int of_mmc_spi_get_cd(struct device *dev)
 	return of_mmc_spi_read_gpio(dev, CD_GPIO);
 }
 
+static int of_mmc_spi_get_cd_inv(struct device *dev)
+{
+	return ! of_mmc_spi_read_gpio(dev, CD_GPIO);
+}
+
 static int of_mmc_spi_get_ro(struct device *dev)
 {
 	return of_mmc_spi_read_gpio(dev, WP_GPIO);
@@ -140,17 +145,26 @@ struct mmc_spi_platform_data *mmc_spi_get_pdata(struct spi_device *spi)
 			oms->alow_gpios[i] = true;
 	}
 
-	if (gpio_is_valid(oms->gpios[CD_GPIO]))
-		oms->pdata.get_cd = of_mmc_spi_get_cd;
+	if (gpio_is_valid(oms->gpios[CD_GPIO])) {
+		if (of_get_property(np, "cd-inverted", NULL))
+			oms->pdata.get_cd = of_mmc_spi_get_cd_inv;
+		else
+			oms->pdata.get_cd = of_mmc_spi_get_cd;
+	}
 	if (gpio_is_valid(oms->gpios[WP_GPIO]))
 		oms->pdata.get_ro = of_mmc_spi_get_ro;
 
-	oms->detect_irq = irq_of_parse_and_map(np, 0);
-	if (oms->detect_irq != 0) {
-		oms->pdata.init = of_mmc_spi_init;
-		oms->pdata.exit = of_mmc_spi_exit;
-	} else {
+	if (of_get_property(np, "np-removable", NULL))
+		oms->pdata.caps |= MMC_CAP_NONREMOVABLE;
+	else if (of_get_property(np, "broken-cd", NULL))
 		oms->pdata.caps |= MMC_CAP_NEEDS_POLL;
+	else {
+		oms->detect_irq = irq_of_parse_and_map(np, 0);
+		if (oms->detect_irq != 0) {
+			oms->pdata.init = of_mmc_spi_init;
+			oms->pdata.exit = of_mmc_spi_exit;
+		} else
+			oms->pdata.caps |= MMC_CAP_NEEDS_POLL;
 	}
 
 	dev->platform_data = &oms->pdata;
-- 
1.7.10.4

